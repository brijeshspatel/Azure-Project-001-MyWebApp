name: PR - Validation

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    name: Validate Pull Request
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Setup .NET
        uses: ./.github/actions/setup-dotnet
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Check code formatting
        continue-on-error: true
        id: format-check
        run: |
          dotnet format --verify-no-changes --verbosity diagnostic
          FORMAT_EXIT_CODE=$?
          echo "exit-code=$FORMAT_EXIT_CODE" >> $GITHUB_OUTPUT
          exit $FORMAT_EXIT_CODE

      - name: Format check result
        if: steps.format-check.outcome == 'failure'
        run: |
          echo "::warning::Code formatting issues detected. Run 'dotnet format' locally to fix."

      - name: Build solution
        run: dotnet build --configuration Release --no-restore

      - name: Run all unit tests
        uses: ./.github/actions/run-tests
        with:
          project-path: MyWebApp.Tests.Unit/MyWebApp.Tests.Unit.csproj
          configuration: Release
          logger: 'trx;LogFileName=pr-test-results.trx'

      - name: Extract test count from results
        id: extract-test-count
        if: always()
        run: |
          # Parse test results to get counts
          if [ -f "**/pr-test-results.trx" ]; then
            TEST_TOTAL=$(grep -oP 'total="\K[0-9]+' **/pr-test-results.trx | head -1)
            TEST_PASSED=$(grep -oP 'passed="\K[0-9]+' **/pr-test-results.trx | head -1)
            TEST_FAILED=$(grep -oP 'failed="\K[0-9]+' **/pr-test-results.trx | head -1)
            
            # Set defaults if not found
            TEST_TOTAL=${TEST_TOTAL:-"unknown"}
            TEST_PASSED=${TEST_PASSED:-"unknown"}
            TEST_FAILED=${TEST_FAILED:-"0"}
          else
            TEST_TOTAL="unknown"
            TEST_PASSED="unknown"
            TEST_FAILED="0"
          fi
          
          echo "test-total=$TEST_TOTAL" >> $GITHUB_OUTPUT
          echo "test-passed=$TEST_PASSED" >> $GITHUB_OUTPUT
          echo "test-failed=$TEST_FAILED" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Tests: $TEST_PASSED/$TEST_TOTAL passed"

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: PR Test Results (${{ steps.extract-test-count.outputs.test-passed }}/${{ steps.extract-test-count.outputs.test-total }} passed)
          path: '**/pr-test-results.trx'
          reporter: dotnet-trx
          fail-on-error: true

      - name: Code Coverage Summary
        uses: irongut/CodeCoverageSummary@v1.3.0
        if: always()
        with:
          filename: '**/coverage.cobertura.xml'
          badge: true
          format: markdown
          output: both

      - name: Add Coverage Comment to PR
        uses: marocchino/sticky-pull-request-comment@v2
        if: github.event_name == 'pull_request' && always()
        with:
          recreate: true
          path: code-coverage-results.md

      - name: Check coverage threshold
        if: always()
        run: |
          echo "Checking code coverage threshold (80% minimum)..."
          
          if [ -f "code-coverage-results.md" ]; then
            echo "âœ… Coverage report generated successfully"
            echo "âš ï¸ Note: Coverage threshold checking should be implemented via quality gates"
          else
            echo "âš ï¸ Coverage report not found"
          fi

      - name: Security vulnerability scan
        uses: ./.github/actions/security-scan

      - name: Upload security scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-security-scan
          path: security-scan.txt
          retention-days: 30

      - name: PR Validation Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ğŸ” PR Validation Summary
          
          ### âœ… Checks Performed
          - **Code Formatting**: ${{ steps.format-check.outcome }}
          - **Build**: ${{ job.status }}
          - **Unit Tests**: ${{ steps.extract-test-count.outputs.test-passed }}/${{ steps.extract-test-count.outputs.test-total }} passed
          - **Code Coverage**: Generated and commented on PR (Target: >80%)
          - **Security Scan**: Vulnerability check completed
          
          ### ğŸ“Š Quality Gates
          - Code formatting compliance
          - All tests must pass (${{ steps.extract-test-count.outputs.test-passed }}/${{ steps.extract-test-count.outputs.test-total }})
          - Code coverage target: >80%
          - No vulnerable dependencies
          
          ### ğŸ¯ Next Steps
          Please address any failing checks before requesting review.
          
          ### â„¹ï¸ Note
          This is PR validation only. Full CI build with artifact creation runs after merge.
          EOF
